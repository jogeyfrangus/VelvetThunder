<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Charts | HydroTracker</title>
    <link rel="stylesheet" href="charts.css">
    <link rel="stylesheet" href="../sitewide.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</head>
<body>

<div class="container-fluid">
    <div class="header col-md-12">
        <h1>Charts</h1>
    </div>

    <nav class="navbar navbar-expand-lg navbar light">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#a-navbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="a-navbar" aria-expanded="false">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href='../goals'>Goals</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../log/water">Logs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../dashboard">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../charts">Charts</a>
                </li>
                <li class="nav-item" id="logout">
                    <a class="nav-link" href="../login">Logout</a>
                </li>
            </ul>
        </div>
    </nav>
</div>

<!--Displaying info through graph-->
<div id="lineChart"></div>

<!--Displaying info through text-->
<div id="infoText"></div>

<div class="col-md-12 text-center">
    <input id="initialDate" type="date" value="2019-11-20" />
    <input id="finalDate" type="date" value="2019-11-28" />
    <button id="updateButton" onclick="drawChart()">Update Chart</button>
</div>
<!-- Standard Firebase Content -->
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-analytics.js"></script>
<script src="https://velvetthunder.firebaseapp.com/customFirebase.js"></script>
<script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
<!-- End Standard Firebase Content -->

<script src="getLogsAndGoals.js"></script>

<!-- Google Charts Code -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    // Load google charts
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(getWaterLog);


    function currentDate() {
        let today = new Date();
        let dateToday = today.getFullYear() + '-' + today.getMonth() + '-' + today.getDate();
        return dateToday.toString();
    }


    // Reading the information stored inside the "Water" document
    function getWaterLog() {
        setTimeout(function () {
            // let waterRef;
            // try {
            //     waterRef = db.collection("Users").doc(currentUser.uid).collection("Log").doc("Water");
            // } catch {
            //     console.log('Current water log is empty.')
            // }
            // let dailyWaterLog = 0;
            // try {
            //     waterRef.get() // Grabbing the data from the document
            //         .then(function (doc) {
            //             dailyWaterLog = doc.data()[currentDate()];
            //             if (dailyWaterLog > 2.5) { // Default water value is 2.5L
            //                 dailyWaterLog = 2.5;
            //             } else if (!dailyWaterLog) {
            //                 dailyWaterLog = 0;
            //             }
            //         })
            //         .catch(function () {
            //             alert("Could not get today's water log."); // If the water log cannot be loaded/no data for the day
            //         })
            // } catch {
            //     console.log('Water get error')
            // }
            // let goalRef;
            // try {
            //     goalRef = db.collection("Users").doc(currentUser.uid).collection("Log").doc("Water");
            // } catch {
            //     console.log('Current goal log is empty.')
            // }
            drawChart()
        }, 1500);
    }

    // Draw the chart and set the chart values
    function drawChart() {
        let initial = document.getElementById('initialDate').value;
        let final = document.getElementById('finalDate').value;
        let allDates = getDatesInRange(initial, final);
        let goals = [];
        let logs = [];
        for (let i = 0; i < allDates.length; i++) {
            getCurrentWaterGoal(allDates[i]).then(function(value) {
                goals[i] = Number(value);
            });
            getCurrentWater(allDates[i]).then(function(value) {
                logs[i] = Number(value);
            });
        }
        let checkInterval = setInterval(function() {
            if (logs.length === allDates.length && goals.length === allDates.length) {
                clearInterval(checkInterval);
                console.log('Drawing chart...');  // temporary, for debugging

                let customChartData = [['Date', 'Goal', 'Water']];
                for (let i = 0; i < allDates.length; i++) {
                    customChartData.push([allDates[i], goals[i], logs[i]]);
                }

                var data = google.visualization.arrayToDataTable(customChartData);

                // Optional; add a title and set the width and height of the chart
                var options = {
                    width: 900,
                    height: 500,
                    colors: ['#A7EEF8', '#8AB2ED'],
                    animation: {duration: 1000,
                        startup: true,
                        easing: 'inAndOut'}};

                // Display the chart inside the <div> element with id="lineChart"
                var chart = new google.visualization.SteppedAreaChart(document.getElementById('lineChart'));
                chart.draw(data, options);
            }
        }, 50);
    }

    // Display the chart information in text
    function displayChartInfoWater(category) {
        let waterRef = db.collection(category).get().then(function (querySnapshot) {
            querySnapshot.forEach(function (doc) {
                let displayedInfo = document.createElement('p');
                document.getElementById('infoText').appendChild(displayedInfo);
                let infoNode = document.createTextNode(doc.data().name);
                displayedInfo.appendChild(infoNode);
            })
        })
    }


    displayChartInfoWater('Logs');

    function getDatesInRange(start, end) {  // Start and end are properly formatted dates, with start being less than end
        let dates = [start];
        let date = start;
        while (true) {
            let dateSplitString = date.split('-');
            let dateSplit = [];
            for (let i = 0; i < dateSplitString.length; i++) {
                dateSplit.push(Number(dateSplitString[i]));
            }
            dateSplit[2] ++;
            if (dateSplit[1] === 1 && dateSplit[2] >= 29) {
                dateSplit[2] = 1;
                dateSplit[1] ++;
            } else if ([1, 3, 5, 7, 8, 10, 12].includes(dateSplit[1]) && dateSplit[2] >= 32) {
                dateSplit[2] = 1;
                dateSplit[1] ++;
            } else if ([2, 4, 6, 9, 11].includes(dateSplit[1]) && dateSplit[2] >= 31) {
                dateSplit[2] = 1;
                dateSplit[1] ++;
            }
            if (dateSplit[1] >= 13) {
                dateSplit[0] ++;
                dateSplit[1] = 1;
            }
            date = String(dateSplit[0]) + '-' + String(dateSplit[1]) + '-' + String(dateSplit[2]);
            dates.push(date);
            if (date >= end) {
                break;
            }
        }
        return dates
    }
</script>

</body>
</html>
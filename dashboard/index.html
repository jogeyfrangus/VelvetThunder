<!DOCTYPE html>
<html lang='en'>

<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
</head>

<body>
    <div class="dashboard-header">
        <h1>Dashboard</h1>
    </div>
<!--        <img src="images/Hydro%20Homies%20Logo.png" id="logo">-->
            <nav class="navbar navbar-expand-md">
        <!--        <a class="navbar-brand" href="">Logo</a>-->
        <!--        <button class="navbar-toggler navbar-dark" type="button" data-toggle="collapse" data-target="#main-navigation">-->
        <!--            <span class="navbar-toggler-icon"></span>-->
        <!--        </button>-->
                <div class="collapse navbar-collapse" id="main-navigation">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href='../goals'>Goals</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../log/water">Logs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../dashboard">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../charts">Charts</a>
                        </li>
                        <li class="nav-item" id="logout">
                            <a class="nav-link" href="../login">Logout</a>
                        </li>
                    </ul>
                </div>
            </nav>



    <div id="piechart"></div>


    <!-- TODO: Add loading message? -->


    <!-- Standard Firebase Content -->
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-analytics.js"></script>
    <script src="https://velvetthunder.firebaseapp.com/customFirebase.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
    <!-- End Standard Firebase Content -->


    <!-- Google Charts Code -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script>
        // Load google charts
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(getWaterLog);


        function currentDate() {
            let today = new Date();
            let dateToday = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
            return dateToday.toString();
        }

        function getCurrentWater() {
            let waterRef;
            try {
                waterRef = db.collection("Users").doc(currentUser.uid).collection("Log").doc("Water");
            } catch {
                console.log('Current water log is empty.')
            }
            let currentWater = 0;
            try {
                waterRef.get() // Grabbing the data from the document
                    .then(function (doc) {
                        currentWater = doc.data()[currentDate()];
                        if (currentWater > 2.5) { // Default water value is 2.5L
                            currentWater = 2.5;
                        } else if (!currentWater) {
                            currentWater = 0;
                        }
                    })
                    .catch(function () {
                        console.log("Could not get today's water log."); // If the water log cannot be loaded/no data for the day
                    })
            } catch {
                console.log('Water get error')
            }
            return currentWater
        }

        function getCurrentWaterGoal(givenDate) {
            let goalRef;
            try {
                goalRef = db.collection("Users").doc(currentUser.uid).collection("Goals").doc("Water");
            } catch {
                console.log('Current water log is empty.')
            }
            let waterGoal = 2.5;
            try {
                goalRef.get() // Grabbing the data from the document
                    .then(function (doc) {
                        waterGoal = doc.data()[givenDate];
                        if (waterGoal !== 0) {
                            if (!waterGoal) {
                                let waterGoalDates = Object.keys(doc.data());
                                waterGoalDates.sort(function(a, b){return b - a});
                                while (waterGoalDates[0] < givenDate) {
                                    waterGoalDates.shift();
                                }
                                try {
                                    waterGoal = doc.data()[waterGoalDates[0]];
                                } catch {
                                    console.log("Error: No water goals found!")
                                }
                            }
                        }
                    })
                    .catch(function () {
                        console.log("Could not get current goal."); // If the water log cannot be loaded/no data for the day
                    })
            } catch {
                console.log('Goal get error')
            }
            return waterGoal
        }

        // Reading the information stored inside the "Water" document
        function getWaterLog() {
            setTimeout(function() {
                let dailyWaterLog = getCurrentWater();
                let currentWaterGoal = getCurrentWaterGoal();
                setTimeout(function() { drawChart(dailyWaterLog, currentWaterGoal) }, 1000);
            }, 1000);
        }

        // Draw the chart and set the chart values
        function drawChart(water, waterGoal) {
            var data = google.visualization.arrayToDataTable([
                ['Daily Log', 'Litres'],
                ['Water Consumed', water],
                ['Remaining Goal', waterGoal - water]
            ]);

            // Optional; add a title and set the width and height of the chart
            var options = {
                chartArea: {
                    width: '40%',
                },
                legend: {
                    alignment: 'center',
                    position: 'top',
                },
                colors: ['#A7EEF8', '#8AB2ED']
            };

            // Display the chart inside the <div> element with id="piechart"
            var chart = new google.visualization.PieChart(document.getElementById('piechart'));
            chart.draw(data, options);
        }

    </script>
</body>

</html>
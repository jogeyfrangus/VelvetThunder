<!DOCTYPE html>
<html lang='en'>

<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>
<div class="dashboard-header">
    <h1>Dashboard</h1>
</div>
<!--        <img src="images/Hydro%20Homies%20Logo.png" id="logo">-->
<nav class="navbar navbar-expand-md">
    <!--        <a class="navbar-brand" href="">Logo</a>-->
    <!--        <button class="navbar-toggler navbar-dark" type="button" data-toggle="collapse" data-target="#main-navigation">-->
    <!--            <span class="navbar-toggler-icon"></span>-->
    <!--        </button>-->
    <div class="collapse navbar-collapse" id="main-navigation">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href='../goals'>Goals</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../log/water">Logs</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../charts">Charts</a>
            </li>
            <li class="nav-item" id="logout">
                <a class="nav-link" href="../login">Logout</a>
            </li>
        </ul>
    </div>
</nav>



<div id="piechart"></div>


<!-- TODO: Add loading message? -->


<!-- Standard Firebase Content -->
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-analytics.js"></script>
<script src="https://velvetthunder.firebaseapp.com/customFirebase.js"></script>
<script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
<!-- End Standard Firebase Content -->


<!-- Google Charts Code -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    // Load google charts
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(getWaterLog);


    function currentDate() {
        let today = new Date();
        let dateToday = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
        return dateToday.toString();
    }

    function getCurrentWater(givenDate) {
        let waterRef;
        try {
            waterRef = db.collection("Users").doc(currentUser.uid).collection("Log").doc("Water");
        } catch {
            console.log('Current water log is empty.')
        }
        let currentWater;
        try {
            waterRef.get() // Grabbing the data from the document
                .then(function (doc) {
                    currentWater = doc.data()[givenDate];
                    if (currentWater > 2.5) { // Default water value is 2.5L
                        currentWater = 2.5;
                    } else if (!currentWater) {
                        currentWater = 0;
                    }
                })
                .catch(function () {
                    console.log("Could not get today's water log."); // If the water log cannot be loaded/no data for the day
                    currentWater = 0;
                })
        } catch {
            console.log('Water get error');
            currentWater = 0;
        }
        let tempPromise = new Promise(function(resolve, reject) {
            let checkInterval = setInterval(function() {
                if (currentWater !== undefined) {
                    clearInterval(checkInterval);
                    resolve(currentWater);
                }
            }, 50);
        });
        return tempPromise
    }

    function getCurrentWaterGoal(givenDate) {
        let goalRef;
        try {
            goalRef = db.collection("Users").doc(currentUser.uid).collection("Goals").doc("Water");
        } catch {
            console.log('Current water log is empty.')
        }
        let waterGoal;  // No default value set, so that the code can check when the computation finishes
        try {
            goalRef.get() // Grabbing the data from the document
                .then(function (doc) {
                    waterGoal = doc.data()[givenDate];  // Get the goal for the requested date (this used to be ...[currentDate()])
                    if (waterGoal !== 0) {
                        if (!waterGoal) {
                            let waterGoalDates = Object.keys(doc.data());  // Get all dates for water goals (object keys)
                            waterGoalDates.sort(function(a, b){return b - a});  // Sort the dates in descending order
                            while (waterGoalDates[0] > givenDate) {  // Remove largest (newest) date until the given date is reached
                                waterGoalDates.shift();  // removes first-index item
                            }
                            try {
                                waterGoal = doc.data()[waterGoalDates[0]];  // Set the goal to the most recent goal
                            } catch {
                                console.log("Error: No water goals found!");
                                waterGoal = 2.5;  // default value set here so that the code knows that the computation is done
                            }
                        }
                    }
                })
                .catch(function () {
                    console.log("Could not get current goal."); // If the water log cannot be loaded/no data for the day
                    waterGoal = 2.5;  // default value set here so that the code knows that the computation is done
                })
        } catch {
            console.log('Goal get error');
            waterGoal = 2.5;  // default value set here so that the code knows that the computation is done
        }
        let tempPromise = new Promise(function(resolve, reject) {  // Create a temporary promise that only resolves when waterGoal is defined
            let checkInterval = setInterval(function() {
                if (waterGoal !== undefined) {
                    clearInterval(checkInterval);
                    console.log('The current goal is ' + String(waterGoal) + 'L');  // temporary, for debugging
                    resolve(waterGoal);
                }
            }, 50);
        });
        return tempPromise
    }

    // Reading the information stored inside the "Water" document
    function getWaterLog() {
        setTimeout(function() {
            let dailyWaterLogPromise = getCurrentWater(currentDate());
            let currentWaterGoalPromise = getCurrentWaterGoal(currentDate());
            let dailyWaterLog;
            let currentWaterGoal;
            dailyWaterLogPromise.then(function(waterOutput) {
                    dailyWaterLog = waterOutput;
            }
            ).catch(function() {
                console.log('Error: dailyWaterLogPromise not fulfilled')
            });
            currentWaterGoalPromise.then(function(waterGoalOutput) {
                    currentWaterGoal = waterGoalOutput;
                }
            ).catch(function() {
                console.log('Error: currentWaterGoalPromise not fulfilled')
            });
            let checkInterval = setInterval(function() {
                if (dailyWaterLog !== undefined && currentWaterGoal !== undefined) {
                    clearInterval(checkInterval);
                    console.log('Drawing chart...');  // temporary, for debugging
                    drawChart(dailyWaterLog, currentWaterGoal);
                }
            }, 50);
        }, 1000);
    }

    // Draw the chart and set the chart values
    function drawChart(water, waterGoal) {
        var data = google.visualization.arrayToDataTable([
            ['Daily Log', 'Litres'],
            ['Water Consumed', water],
            ['Remaining Goal', waterGoal - water]
        ]);

        // Optional; add a title and set the width and height of the chart
        var options = {
            chartArea: {
                width: '100%',
            },
            legend: {
                alignment: 'center',
                position: 'top',
            },
            colors: ['#A7EEF8', '#8AB2ED']
        };

        // Redraw chart based on size of window
        $(window).resize(function () {
            if(this.resizeTO) clearTimeout(this.resizeTO);
            this.resizeTO = setTimeout(function () {
                $(this).trigger('resizeEnd');
            }, 100)
        });
        // Display the chart inside the <div> element with id="piechart"
        var chart = new google.visualization.PieChart(document.getElementById('piechart'));
        chart.draw(data, options);
        // Resize the window based on if the window size has changed
        $(window).on('resizeEnd', function () {
            chart.draw(data, options);
        });

    }

</script>
</body>

</html>